<!DOCTYPE html>
<html>
<head>
    <title>Extension Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .status { padding: 5px 10px; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>🧪 Chrome Extension Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Extension Load Test</h2>
        <div id="extension-status" class="status">Testing...</div>
        <button onclick="testExtension()">Test Extension</button>
    </div>
    
    <div class="test-section">
        <h2>2. Storage Test</h2>
        <div id="storage-status" class="status">Testing...</div>
        <button onclick="testStorage()">Test Storage</button>
    </div>
    
    <div class="test-section">
        <h2>3. Zalando Selector Test</h2>
        <div id="selector-status" class="status">Testing...</div>
        <button onclick="testSelectors()">Test Selectors</button>
        
        <!-- Mock Zalando image for testing -->
        <div style="margin: 10px 0;">
            <h4>Mock Product Image:</h4>
            <img data-testid="product_gallery-media-slider-image-0" 
                 src="https://via.placeholder.com/400x600/667eea/ffffff?text=Test+Product" 
                 alt="Test product" 
                 style="width: 200px; height: 300px; border: 1px solid #ccc;">
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. API Test</h2>
        <div id="api-status" class="status">Not tested</div>
        <button onclick="testAPI()">Test API</button>
        <input type="text" id="test-api-key" placeholder="Enter API key to test" style="width: 300px; margin: 5px;">
    </div>

    <script>
        function testExtension() {
            const statusDiv = document.getElementById('extension-status');
            
            if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                statusDiv.className = 'status success';
                statusDiv.textContent = '✅ Extension loaded successfully';
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ Extension not loaded or not accessible';
            }
        }

        function testStorage() {
            const statusDiv = document.getElementById('storage-status');
            
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get(['geminiApiKey', 'userPhoto'], function(result) {
                    const hasApiKey = !!result.geminiApiKey;
                    const hasPhoto = !!result.userPhoto;
                    
                    if (hasApiKey && hasPhoto) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '✅ Both API key and photo configured';
                    } else if (hasApiKey || hasPhoto) {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = `⚠️ Partial setup: API key: ${hasApiKey}, Photo: ${hasPhoto}`;
                    } else {
                        statusDiv.className = 'status error';
                        statusDiv.textContent = '❌ No API key or photo configured';
                    }
                });
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ Chrome storage API not available';
            }
        }

        function testSelectors() {
            const statusDiv = document.getElementById('selector-status');
            
            // Test primary selectors
            const primarySelectors = [
                'img[data-testid*="product_gallery-media-slider-image-"]',
                'img[data-testid*="product_gallery-thumbnail-carousel-image-"]'
            ];
            
            let found = 0;
            let foundSelectors = [];
            
            primarySelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    found += elements.length;
                    foundSelectors.push(`${selector} (${elements.length})`);
                }
            });
            
            if (found > 0) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `✅ Found ${found} images: ${foundSelectors.join(', ')}`;
            } else {
                statusDiv.className = 'status warning';
                statusDiv.textContent = '⚠️ No product images found with primary selectors (normal on this test page)';
            }
        }

        async function testAPI() {
            const statusDiv = document.getElementById('api-status');
            const apiKey = document.getElementById('test-api-key').value.trim();
            
            if (!apiKey) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ Please enter API key';
                return;
            }
            
            statusDiv.className = 'status warning';
            statusDiv.textContent = '🔄 Testing API...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Hello, just testing API connectivity.' }]
                        }]
                    })
                });
                
                if (response.ok) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '✅ API key working correctly';
                } else {
                    const error = await response.text();
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `❌ API Error: ${error}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Network Error: ${error.message}`;
            }
        }

        // Run initial tests
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testExtension();
                testStorage();
                testSelectors();
            }, 1000);
        });
    </script>
</body>
</html>